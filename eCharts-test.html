<!doctype html>
<html lang="en">

<head>
	<title>COVID-19 Coronavirus Disease Spread Analysis in German Regions and the World</title>
	<meta charset="utf-8">
	<meta name="author" content="Dr. Torben Menke">
	<!-- <link rel="stylesheet" href="/style.css" /> -->
	<link rel="stylesheet" href="style-covid.css" />
	<!-- Polyfiles for IE, suggested by Tabulator : http://tabulator.info/docs/4.6/browsers#ie -->
	<script src="./tabulator/polyfill.min.js"></script>
	<script src="./tabulator/fetch.umd.js"></script>
	<!-- eCharts -->
	<script src="./eCharts/echarts-4.7.0-en.min.js"></script>
	<script src="./eCharts/jquery-3.5.0.min.js"></script>
	<script src="./eCharts/myHelper3.js"></script>
	<!-- <script src="https://cdn.bootcss.com/echarts/4.1.0.rc2/echarts-en.min.js"></script> -->
	<style>
		.echart-wrap {
			display: inline-block;
			width: 700px;
			height: 700px;
			overflow: scroll;
			border: 1px solid black;
		}
	</style>
</head>

<body>
	<div class="echart-wrap">
		<div id="canvas1" style="height: 2000px">
		</div>
	</div>
	<script>
		// array of promises for async fetching, used for eCharts plots
		const promises = [];




		// fetch mapping_landkreis_ID_name.json reference data like code and continent
		var array_countries_latest = {};
		function fetch_countries_latest(array_countries_latest) {
			const url =
				"https://entorb.net/COVID-19-coronavirus/data/int/countries-latest-all.json";
			return $.getJSON(url, function (data) {
				console.log("success: array_countries_latest");
			})
				.done(function (data) {
					console.log("done: array_countries_latest");
					$.each(data, function (key, val) {
						code = data[key]['Code'];
						array_countries_latest[code] = val;
						delete array_countries_latest[code]['Code'];
					});
					// console.log(array_countries_latest);

				})
				.fail(function () {
					console.log("fail: array_countries_latest");
				});
		}
		promises.push(fetch_countries_latest(array_countries_latest));


		var data_names = [];  //array_countries_latest.keys();
		var data_values = [];
		var countryLatestData = {};


		// Wait for all async promises to be done (all data is fetched)
		Promise.all(promises).then(function () {
			// console.log(array_countries_latest);
			setDataToPlot('canvas1', 'Cases_Last_Week_Per_100000', 'ASC')
			//setDataToPlot('DoublingTime_Cases_Last_Week_Per_100000', 'DESC')

		});



		function setDataToPlot(eChartsObjectID, property, ordering) {

			let sortmap = [];
			const codes_ordered = [];

			for (const [key, values] of Object.entries(array_countries_latest)) {
				if (property in values) {
					value = values[property];
					sortmap.push([key, value]);
				}
			}
			sortmap.sort(function (a, b) {
				return a[1] - b[1];
			});
			for (let i = 0; i < sortmap.length; i++) {
				codes_ordered.push(sortmap[i][0]);
			}
			if (ordering == 'DESC') {
				codes_ordered.reverse();
			}

			for (let i = 0; i < codes_ordered.length; i++) {
				name = array_countries_latest[codes_ordered[i]]['Country'];
				data_names.push(name);
				value = array_countries_latest[codes_ordered[i]][property];
				data_values.push(value);
			}

			option = {
				yAxis: {
					type: 'category',
					data: data_names,
				},
				xAxis: {
					type: 'value',
					position: 'top',
				},
				series: [{
					data: data_values,
					type: 'bar'
				}]
			};

			let echartsObj = echarts.init(document.getElementById(eChartsObjectID));
			echartsObj.setOption(option)
		}







	</script>
</body>

</html>